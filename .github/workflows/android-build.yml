name: Android Build and Release

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  release:
    types: [published]

jobs:
  build:
    name: Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3
      with:
        api-level: 34
        build-tools-version: 34.0.0
        cmake-version: 3.22.1
        ndk-version: 25.2.9519653

    - name: Grant execute permission for gradlew
      run: chmod +x ./gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug
      continue-on-error: false

    - name: Build Release APK
      run: |
        ./gradlew assembleRelease
      env:
        ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
        ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

    - name: Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: spaceship-game-debug
        path: app/build/outputs/apk/debug/app-debug.apk
        retention-days: 7

    - name: Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: spaceship-game-release
        path: app/build/outputs/apk/release/app-release.apk
        retention-days: 30

    - name: Upload Mapping File
      uses: actions/upload-artifact@v4
      with:
        name: mapping-file
        path: app/build/outputs/mapping/release/mapping.txt
        retention-days: 30

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    needs: build
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Run Unit Tests
      run: ./gradlew testDebugUnitTest

    - name: Run Instrumented Tests
      run: ./gradlew connectedAndroidTest
      continue-on-error: true

    - name: Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: app/build/reports/
        retention-days: 7

  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Run Lint
      run: ./gradlew lintDebug

    - name: Upload Lint Report
      uses: actions/upload-artifact@v4
      with:
        name: lint-report
        path: app/build/reports/lint/
        retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, test, lint]
    if: github.event_name == 'release'
    
    steps:
    - name: Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: spaceship-game-release
        path: ./release-files

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: ./release-files/*
        body: |
          # SpaceShip Galaxy Wars ğŸš€
          
          Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù†Ø³Ø®Ù‡ Ø¨Ø§Ø²ÛŒ SpaceShip Galaxy Wars
          
          ## ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡:
          - Ú¯Ø±Ø§ÙÛŒÚ© Ø³Ù‡ Ø¨Ø¹Ø¯ÛŒ ÙÙˆÙ‚ Ø§Ù„Ø¹Ø§Ø¯Ù‡
          - Ø³ÛŒØ³ØªÙ… Ø°Ø±Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡
          - Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø¯Ø´Ù…Ù†Ø§Ù†
          - Ø³ÛŒØ§Ø±Ø§Øª Ù…ØªÙ†ÙˆØ¹ Ø¨Ø§ Ø¬Ø²Ø¦ÛŒØ§Øª
          - Ø³ÛŒØ³ØªÙ… Ù‚Ø¯Ø±Øªâ€ŒØ¢Ù¾Ú¯Ø±ÛŒØ¯
          - Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ Ùˆ Ù…Ø£Ù…ÙˆØ±ÛŒØªâ€ŒÙ‡Ø§
          
          ## Ù†Ø­ÙˆÙ‡ Ù†ØµØ¨:
          1. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯
          2. Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ØŒ "Ù†ØµØ¨ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹ Ù†Ø§Ø´Ù†Ø§Ø³" Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯
          3. ÙØ§ÛŒÙ„ APK Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯
          4. Ø¨Ø§Ø²ÛŒ Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ Ùˆ Ù„Ø°Øª Ø¨Ø¨Ø±ÛŒØ¯!
          
          ## Ø³ÛŒØ³ØªÙ… Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø²:
          - Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ûµ.Û° (API 21) ÛŒØ§ Ø¨Ø§Ù„Ø§ØªØ±
          - Ø­Ø¯Ø§Ù‚Ù„ Û²GB RAM
          - Û±Û°Û°MB ÙØ¶Ø§ÛŒ Ø®Ø§Ù„ÛŒ
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
