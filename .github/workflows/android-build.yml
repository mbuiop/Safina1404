name: Android Game CI/CD

on:
  push:
    branches: [ main, develop ]
  release:
    types: [published]

env:
  UNITY_VERSION: '2022.3.21f1'
  ANDROID_SDK_VERSION: '9477386'

jobs:
  build-unity-android:
    name: Build Unity Android Game
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        lfs: true
        
    - name: Cache Unity modules
      uses: actions/cache@v3
      with:
        path: |
          /opt/unity/Editor/Data/PlaybackEngines/AndroidPlayer
          ~/.gradle/caches
        key: ${{ runner.os }}-unity-android-${{ env.UNITY_VERSION }}
        
    - name: Build Unity Project (Android)
      uses: game-ci/unity-builder@v4
      env:
        UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
        UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
        UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
      with:
        targetPlatform: Android
        androidAppBundle: true
        androidKeystoreName: user.keystore
        androidKeystoreBase64: ${{ secrets.ANDROID_KEYSTORE }}
        androidKeystorePass: ${{ secrets.ANDROID_KEYSTORE_PASS }}
        androidKeyaliasName: ${{ secrets.ANDROID_KEYALIAS_NAME }}
        androidKeyaliasPass: ${{ secrets.ANDROID_KEYALIAS_PASS }}
        
    - name: Upload APK/AAB
      uses: actions/upload-artifact@v4
      with:
        name: Android-Build
        path: build/
        retention-days: 30

  deploy:
    name: Deploy to Testing
    runs-on: ubuntu-latest
    needs: build-unity-android
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: Android-Build
        
    - name: Deploy to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1
      with:
        appId: ${{ secrets.FIREBASE_APP_ID }}
        token: ${{ secrets.FIREBASE_TOKEN }}
        groups: testers
        file: "*.apk"



